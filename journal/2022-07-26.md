# Tuesday, July 26, 2022
# Critical Section
ê³µìœ ë˜ëŠ” ìì›ì— ë™ì‹œì— ì ‘ê·¼ì´ ë°œìƒí•˜ì—¬ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ë…ì ì„±ì„ ë³´ì¥í•´ì£¼ëŠ” ì˜ì—­.
## Mutex
í•œ ì“°ë ˆë“œ, í”„ë¡œì„¸ìŠ¤ì— ì˜í•´ ì†Œìœ ë  ìˆ˜ ìˆëŠ” KeyğŸ”‘ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ìƒí˜¸ë°°ì œê¸°ë²•
mutex lockì´ lockì„ íšë“í•˜ì§€ ëª»í•˜ë©´ struct mutex.wait_listì— ë“±ë¡í•˜ê³  ì ë“¤ì–´ë²„ë ¤ìš”.
mutex lockì´ í•´ì œë  ë•Œ mutex lockì„ í•´ì œí•˜ëŠ” í”„ë¡œì„¸ìŠ¤ì—ì„œ mutex lockì´ lockì„ íšë“í•˜ì§€ ëª»í•´ ì ë“  í”„ë¡œì„¸ìŠ¤ë¥¼ ê¹¨ìš°ê±°ë“ ìš”.
mutex lockì— ë¬¸ì œê°€ ìƒê¸°ë©´ ë³´í†µ í‚¤ë³´ë“œ ë™ì‘ì´ ì•ˆë˜ê±°ë‚˜ ëª¨ë°”ì¼ì¸ ê²½ìš° í„°ì¹˜ ë™ì‘ì´ ì•ˆë˜ë“¯ ë½ì—…ìœ¼ë¡œ ë¬¸ì œê°€ ì¬í˜„
ë®¤í…ìŠ¤ëŠ” íœ´ë©´ì„ ì§€ì›í•˜ë©° í”„ë¡œì„¸ìŠ¤ ì»¨íƒìŠ¤íŠ¸ì—ì„œ ì£¼ë¡œ ì“°ëŠ” ë½(Locking) ê¸°ë²•ì…ë‹ˆë‹¤
ï‚Ÿ	ë®¤í…ìŠ¤ íšë“: ì´ë¯¸ ë®¤í…ìŠ¤ë¥¼ ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ê°€ íšë“í–ˆìœ¼ë©´ íœ´ë©´ì— ì§„ì…
ï‚Ÿ	ë®¤í…ìŠ¤ í•´ì œ: ë®¤í…ìŠ¤ë¥¼ ê¸°ë‹¤ë¦¬ë©° íœ´ë©´ì— ì§„ì…í•œ í”„ë¡œì„¸ìŠ¤ë¥¼ ê¹¨ì›€ 
### struct mutex
``` C
struct mutex {
    atomic_long_t		owner;
    spinlock_t		wait_lock;
#ifdef CONFIG_MUTEX_SPIN_ON_OWNER
    struct optimistic_spin_queue osq; /* Spinner MCS lock */
#endif
    struct list_head	wait_list;
#ifdef CONFIG_DEBUG_MUTEXES
    void			*magic;
#endif
#ifdef CONFIG_DEBUG_LOCK_ALLOC
    struct lockdep_map	dep_map;
#endif
};
```
atomic_long_t owner;
ë®¤í…ìŠ¤ë¥¼ íšë“í•œ í”„ë¡œì„¸ìŠ¤ì˜ íƒœìŠ¤í¬ ë””ìŠ¤í¬ë¦½í„° ì£¼ì†Œë¥¼ ì €ì¥
struct list_head wait_list;
ë®¤í…ìŠ¤ë½ì„ ê¸°ë‹¤ë¦¬ëŠ” í”„ë¡œì„¸ìŠ¤ ì •ë³´
### struct mutex_waiter
``` c
struct mutex_waiter {
	struct list_head	list;
	struct task_struct	*task;
	struct ww_acquire_ctx	*ww_ctx;
#ifdef CONFIG_DEBUG_MUTEXES
	void			*magic;
#endif
};
```
struct list_head	list;
ë®¤í…ìŠ¤ë¥¼ íšë“ì„ ì‹œë„í•˜ê°€ ì ë“  í”„ë¡œì„¸ìŠ¤ì˜ ì—°ê²° ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. struct mutex êµ¬ì¡°ì²´ wait_list í•„ë“œê°€ list í•„ë“œ ì£¼ì†Œë¥¼ ì €ì¥í•©ë‹ˆë‹¤.  
struct task_struct	*task;
ë®¤í…ìŠ¤ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” í”„ë¡œì„¸ìŠ¤ì˜ íƒœìŠ¤í¬ ë””ìŠ¤í¬ë¦½í„° ì£¼ì†Œë¥¼ ì €ì¥í•©ë‹ˆë‹¤. ë®¤í…ìŠ¤ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” í”„ë¡œì„¸ìŠ¤ì˜ íƒœìŠ¤í¬ ë””ìŠ¤í¬ë¦½í„° ì£¼ì†Œì…ë‹ˆë‹¤. ë®¤í…ìŠ¤ë¥¼ ì–´ëŠ í”„ë¡œì„¸ìŠ¤ê°€ íšë“í–ˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆëŠ” í•µì‹¬ ìë£Œêµ¬ì¡°ì…ë‹ˆë‹¤.


## Spinlock
Signaling mechanism. í˜„ì¬ ê³µìœ ìì›ì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì“°ë ˆë“œ, í”„ë¡œì„¸ìŠ¤ì˜ ìˆ˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°’ì„ ë‘ì–´ ìƒí˜¸ë°°ì œë¥¼ ë‹¬ì„±í•˜ëŠ” ê¸°ë²•
busy-waitingì´ë¼ëŠ” ë§ì„ ë“¤ì–´ë³´ì…¨ë‚˜ìš”? spinlockì€ lockì„ íšë“í•˜ê¸° ì „ê¹Œì§€ ì‚¬ì±„ì—…ì ê°™ì´ ê³„ì† íŠ¹ì • ë£¨í”„ë¥¼ ëŒë©´ì„œ ê³„ì† ê¸°ë‹¤ë ¤ìš”.
spinlock ë™ì‘ì— ë¬¸ì œê°€ ìƒê¸°ë©´ Watchdog Resetìœ¼ë¡œ ì‹œìŠ¤í…œì€ ë¦¬ì…‹ë˜ëŠ” ìš´ëª…ì„ ë§ì´í•˜ê²Œ ë˜ìš”.
### spin_lock
ì‹¤ì œ êµ¬í˜„ë¶€ëŠ” __raw_spin_lock() í•¨ìˆ˜
spin_lock -> raw_spin_lock -> __raw_spin_lock
preempt_count_add(1) í•¨ìˆ˜ í˜¸ì¶œë¡œ ê°‘ìê¸° irqê°€ í˜¸ì¶œë  ì‹œ preemptionì„ ë§‰ê³ 
ë°”ë¡œ do_raw_spin_lock() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ”êµ°ìš”.
=>
spinlockì„ ê±°ëŠ” êµ¬ê°„ì´ ë¹¨ë¦¬ ìˆ˜í–‰ë˜ê±°ë‚˜ IRQê°€ triggerë˜ì–´ preemptionë˜ì–´ë„ ë¬¸ì œê°€ ì•ˆë  ë•Œ ì“¸ ìˆ˜ ìˆì–´ìš”.
spin_lock ë‚´ í•¨ìˆ˜ í˜¸ì¶œì´ ì—†ëŠ” ê²½ìš° ì“°ë©´ ì¢‹ê² ì£ .
### spin_lock_irq
ì‹¤ì œ êµ¬í˜„ë¶€ëŠ” __raw_spin_lock_irq() í•¨ìˆ˜
spin_lock_irq -> raw_spin_lock_irq -> __raw_spin_lock_irq
arch_local_irq_disable()ì„ í˜¸ì¶œí•´ë²„ë ¤ì„œ "msr daifset, #2" ARM64(Aarch64) ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì´
ìˆ˜í–‰ë˜ì–´ ì•„ì˜ˆ IRQê°€ í•˜ë“œì›¨ì–´ì ìœ¼ë¡œ Triggerê°€ ì•ˆë˜ê²Œ ì°¨ë‹¨.
preempt_count_add(1)ì„ í˜¸ì¶œí•´ì„œ IRQê°€ í˜¹ì‹œ triggerë  ì‹œ preemptionì´ ì•ˆ ë˜ë„ë¡ ë°©ì§€
=>
arch_local_irq_disable()ì„ í˜¸ì¶œí•´ë²„ë ¤ì„œ "msr daifset, #2" ARM64(Aarch64) ì¸ìŠ¤íŠ¸ëŸ­ì…˜ì´
ìˆ˜í–‰ë˜ì–´ spin_unlock_irq()ì´ ìˆ˜í–‰ë  ë•Œ ê¹Œì§€ ì•„ì˜ˆ IRQê°€ í•˜ë“œì›¨ì–´ì ìœ¼ë¡œ Triggerê°€ ë¨¹í†µì´ ë˜ë²„ë¦¬ê±°ë“ ìš”.
spin_lock_irq()ëŠ” ê±°ëŠ” êµ¬ê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ìˆ˜í–‰ë˜ëŠ” ì½”ë“œë©´ ì‹œìŠ¤í…œì´ ëŠë ¤ì§€ê²Œ ë˜ê² ì£ .
### spin_lock_irqsave
ì‹¤ì œ êµ¬í˜„ë¶€ëŠ” __raw_spin_lock_irqsave() í•¨ìˆ˜
raw_spin_lock_irqsave -> _raw_spin_lock_irqsave -> __raw_spin_lock_irqsave
arch_local_irq_save()í•¨ìˆ˜ì˜ êµ¬í˜„ë¶€ë¥¼ ë³´ë©´, í¬ê²Œ 2ê°€ì§€ ì¼ì„ í•˜ê³  ìˆì–´ìš”.
[1]: "mrs %0, daif" // Interrupt disable flagì„ ì„¤ì •í•œ í›„ í•´ë‹¹ ê°’ì„ flagsì— ì €ì¥
[2]:"msr daifset, #2"" // í•˜ë“œì›¨ì–´ì ìœ¼ë¡œ IRQë¥¼ disableí•¨
ì—¬ê¸°ì„œ ì¤‘ìš”í•œ í¬ì¸íŠ¸ëŠ” flagsë¥¼ ì €ì¥í•´ì„œ ë¦¬í„´í•œë‹¤ëŠ” ê±´ë°ìš”.
ë‚˜ì¤‘ì— spin_unlock_irqrestore() í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì–´ ì•„ë˜ ìˆœì„œë¡œ arch_local_irq_restore() í•¨ìˆ˜ì˜ íŒŒë¼ë¯¸í„°ë¡œ ì“°ì´ê²Œ ë˜ìš”.
 __raw_spin_unlock_irqrestore -> local_irq_restore -> arch_local_irq_restore
 =>
spin_lock_irq() í•¨ìˆ˜ë‘ ê¸°ëŠ¥ì ìœ¼ë¡œ ë‹¤ë¥¸ê²Œ ì•„ë¬´ê²ƒë„ ì—†ê±°ë“ ìš”.
 arch_local_irq_save() í˜¸ì¶œë¡œ  "mrs %0, daif" Instructionì´ ìˆ˜í–‰ë˜ì–´ interrupt flagsë¥¼ ê°€ì ¸ì˜¨ë‹¤ëŠ” ì ë§Œ ë‹¤ë¥¸ë°ìš”.
ARM64 Instructionì„ í™œìš©í•´ì„œ Interruptì„ enable ë•Œì˜ ê³ ìœ í•œ flagë¥¼  "msr daifset, #2"ë¡œ ë¦¬í„´í•˜ê³ 
Interruptì„ disable ë•Œ ì´ì „ì— ì„¤ì •í•œ flagë¡œ  "msr daif, %0"  Interruptì„ disableí•˜ê²Œ ë˜ìš”.
## Semaphore
### down, down_interruptible, down_trylock
mutex, spinlock, semaphore ì •ë¦¬
## ì¶œì²˜
https://worthpreading.tistory.com/90
http://rousalome.egloos.com/9966342
http://rousalome.egloos.com/9967067